name: CI

on:
  push:
    branches: [ main ]
  pull_request:

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ENABLE_GOLDEN: "0"
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    strategy:
      matrix:
        include:
          - name: native
            env: native
            usb: ''
            command: pio test -e native
          - name: teensy40
            env: teensy40
            usb: USB_MIDI_SERIAL
            command: pio run -e teensy40
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Surface build flag defaults
        run: |
          echo "SeedBoxConfig.h keeps the canonical build flags:"
          python scripts/describe_seedbox_config.py --format=markdown

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Confirm Teensy USB type
        if: ${{ matrix.usb != '' }}
        run: |
          python - <<'PY'
          from configparser import ConfigParser
          from pathlib import Path
          import sys

          env = "${{ matrix.env }}"
          expected = "${{ matrix.usb }}"

          config = ConfigParser(allow_no_value=True, strict=False)
          config.optionxform = str

          ini_path = Path("platformio.ini")
          if not ini_path.exists():
              print("platformio.ini not found", file=sys.stderr)
              sys.exit(1)

          with ini_path.open() as ini_file:
              config.read_file(ini_file)

          section = f"env:{env}"
          if section not in config:
              print(f"Environment section {section} missing", file=sys.stderr)
              sys.exit(1)

          usb_value = config[section].get("board_build.usbtype")
          if usb_value is None:
              print(f"No USB type configured for {env}", file=sys.stderr)
              sys.exit(1)

          usb_value = usb_value.strip()
          if usb_value != expected:
              print(
                  f"USB type mismatch for {env}: expected {expected}, found {usb_value}",
                  file=sys.stderr,
              )
              sys.exit(1)

          print(f"USB type for {env}: {usb_value}")
          PY

      - name: Execute ${{ matrix.name }} target
        run: ${{ matrix.command }}

      - name: Run native golden harness
        if: ${{ matrix.name == 'native' }}
        env:
          PLATFORMIO_BUILD_FLAGS: -D ENABLE_GOLDEN=1
          ENABLE_GOLDEN: "1"
          SEEDBOX_PROJECT_ROOT: ${{ github.workspace }}
          SEEDBOX_FIXTURE_ROOT: ${{ github.workspace }}/build/fixtures
        run: pio test -e native_golden

      - name: Refresh golden manifest
        if: ${{ matrix.name == 'native' }}
        run: |
          if [ ! -d build/fixtures ]; then
            echo "::error::Golden fixtures missing at build/fixtures. Did native_golden run?" >&2
            if [ -d build ]; then
              ls build
            fi
            exit 1
          fi
          python scripts/compute_golden_hashes.py --write

      - name: Regenerate golden fixture header
        if: ${{ matrix.name == 'native' }}
        run: python scripts/generate_native_golden_header.py

      - name: Stage golden fixtures for upload
        if: ${{ matrix.name == 'native' }}
        run: |
          mkdir -p artifacts/native_golden
          if [ ! -d build/fixtures ]; then
            echo "::error::Golden fixtures missing at build/fixtures. Cannot stage artifacts." >&2
            exit 1
          fi
          rsync -a build/fixtures/ artifacts/native_golden/
          cp tests/native_golden/golden.json artifacts/native_golden/

      - name: Archive golden fixtures
        if: ${{ matrix.name == 'native' }}
        run: tar -czf artifacts/native_golden.tar.gz -C artifacts native_golden

      - name: Note missing signing key for golden fixtures
        if: ${{ matrix.name == 'native' && env.GPG_PRIVATE_KEY == '' }}
        run: 'echo "::notice::Skipping signing: GPG_PRIVATE_KEY is not configured for this run."'

      - name: Import signing key for golden fixtures
        if: ${{ matrix.name == 'native' && env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ env.GPG_PRIVATE_KEY }}
        run: echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign golden fixtures
        if: ${{ matrix.name == 'native' && env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --local-user 4473F115745A1A61 \
              --detach-sign artifacts/native_golden.tar.gz

      - name: Upload native golden artifacts
        if: ${{ matrix.name == 'native' }}
        uses: actions/upload-artifact@v4
        with:
          name: native-golden-fixtures
          path: |
            artifacts/native_golden
            artifacts/native_golden.tar.gz
          if-no-files-found: error

      - name: Upload native golden signature
        if: ${{ matrix.name == 'native' && env.GPG_PRIVATE_KEY != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: native-golden-fixtures
          path: artifacts/native_golden.tar.gz.sig
          if-no-files-found: error

  macos-universal:
    name: macOS universal VST3 + app
    needs: build
    runs-on: macos-14
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      APPLE_SIGNING_CERT_BASE64: ${{ secrets.APPLE_SIGNING_CERT_BASE64 }}
      APPLE_SIGNING_CERT_PASSWORD: ${{ secrets.APPLE_SIGNING_CERT_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
      APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
      APPLE_NOTARY_KEY_BASE64: ${{ secrets.APPLE_NOTARY_KEY_BASE64 }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew update
          brew install ninja gnupg

      - name: Configure universal build
        run: |
          cmake -S . -B build/juce \
            -G Ninja \
            -DSEEDBOX_SIM=ON \
            -DQUIET_MODE=ON \
            -DSEEDBOX_VERSION="${{ github.sha }}" \
            -DJUCE_VST3_CAN_REPLACE_VST2=OFF \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build VST3 and standalone app
        run: cmake --build build/juce --config ${BUILD_TYPE} --target SeedboxVST3 SeedboxVST3_VST3 SeedboxApp

      - name: Inspect universal binaries
        run: |
          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "VST3 bundle not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          VST3_BINARY=$(find "$VST3_BUNDLE" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$VST3_BINARY" ]]; then
            echo "Could not locate a binary under $VST3_BUNDLE/Contents/MacOS" >&2
            find "$VST3_BUNDLE" -maxdepth 6 -print
            exit 1
          fi
          lipo -info "$VST3_BINARY"
          APP_BUNDLE=$(find build/juce/SeedboxApp_artefacts -path "*SeedBox Standalone.app" -maxdepth 5 -print -quit)
          if [[ -z "$APP_BUNDLE" ]]; then
            echo "SeedBox Standalone.app not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 5 -print
            exit 1
          fi
          APP_BINARY=$(find "$APP_BUNDLE" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$APP_BINARY" ]]; then
            echo "Could not locate a binary under $APP_BUNDLE/Contents/MacOS" >&2
            find "$APP_BUNDLE" -maxdepth 5 -print
            exit 1
          fi
          lipo -info "$APP_BINARY"

      - name: Note missing macOS signing + notarization credentials
        if: >-
          ${{
            env.APPLE_SIGNING_CERT_BASE64 == '' ||
            env.APPLE_SIGNING_CERT_PASSWORD == '' ||
            env.APPLE_SIGNING_IDENTITY == '' ||
            env.APPLE_NOTARY_KEY_ID == '' ||
            env.APPLE_NOTARY_ISSUER_ID == '' ||
            env.APPLE_NOTARY_KEY_BASE64 == ''
          }}
        run: |
          echo "::notice::Skipping macOS signing + notarization: Apple Developer ID and notary credentials are not fully configured."

      - name: Sign and notarize macOS bundles
        if: >-
          ${{
            env.APPLE_SIGNING_CERT_BASE64 != '' &&
            env.APPLE_SIGNING_CERT_PASSWORD != '' &&
            env.APPLE_SIGNING_IDENTITY != '' &&
            env.APPLE_NOTARY_KEY_ID != '' &&
            env.APPLE_NOTARY_ISSUER_ID != '' &&
            env.APPLE_NOTARY_KEY_BASE64 != ''
          }}
        env:
          KEYCHAIN_PASSWORD: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euo pipefail

          echo "Creating a temporary keychain for codesigning."
          KEYCHAIN_PATH="$RUNNER_TEMP/seedbox-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          echo "Importing Developer ID Application identity."
          CERT_PATH="$RUNNER_TEMP/seedbox-developer-id.p12"
          echo "$APPLE_SIGNING_CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_SIGNING_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "VST3 bundle not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          APP_BUNDLE=$(find build/juce/SeedboxApp_artefacts -path "*SeedBox Standalone.app" -maxdepth 5 -print -quit)
          if [[ -z "$APP_BUNDLE" ]]; then
            echo "SeedBox Standalone.app not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 5 -print
            exit 1
          fi

          echo "Codesigning VST3 and standalone app with hardened runtime."
          codesign --deep --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$VST3_BUNDLE"
          codesign --deep --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$APP_BUNDLE"

          echo "Preparing App Store Connect API key for notarization."
          NOTARY_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APPLE_NOTARY_KEY_BASE64" | base64 --decode > "$NOTARY_KEY_PATH"

          echo "Submitting VST3 bundle for notarization."
          VST3_ZIP="$RUNNER_TEMP/SeedBox.vst3.zip"
          ditto -c -k --keepParent "$VST3_BUNDLE" "$VST3_ZIP"
          xcrun notarytool submit "$VST3_ZIP" \
            --key "$NOTARY_KEY_PATH" \
            --key-id "$APPLE_NOTARY_KEY_ID" \
            --issuer "$APPLE_NOTARY_ISSUER_ID" \
            --wait

          echo "Submitting standalone app for notarization."
          APP_ZIP="$RUNNER_TEMP/SeedBox-Standalone.app.zip"
          ditto -c -k --keepParent "$APP_BUNDLE" "$APP_ZIP"
          xcrun notarytool submit "$APP_ZIP" \
            --key "$NOTARY_KEY_PATH" \
            --key-id "$APPLE_NOTARY_KEY_ID" \
            --issuer "$APPLE_NOTARY_ISSUER_ID" \
            --wait

          echo "Stapling notarization tickets."
          xcrun stapler staple "$VST3_BUNDLE"
          xcrun stapler staple "$APP_BUNDLE"

          echo "Cleaning up temporary keychain."
          security delete-keychain "$KEYCHAIN_PATH"

      - name: Verify macOS bundle signatures
        if: >-
          ${{
            env.APPLE_SIGNING_CERT_BASE64 != '' &&
            env.APPLE_SIGNING_CERT_PASSWORD != '' &&
            env.APPLE_SIGNING_IDENTITY != '' &&
            env.APPLE_NOTARY_KEY_ID != '' &&
            env.APPLE_NOTARY_ISSUER_ID != '' &&
            env.APPLE_NOTARY_KEY_BASE64 != ''
          }}
        run: |
          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "VST3 bundle not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          APP_BUNDLE=$(find build/juce/SeedboxApp_artefacts -path "*SeedBox Standalone.app" -maxdepth 5 -print -quit)
          if [[ -z "$APP_BUNDLE" ]]; then
            echo "SeedBox Standalone.app not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 5 -print
            exit 1
          fi
          codesign --verify --deep --strict --verbose=2 "$VST3_BUNDLE"
          spctl -a -vv "$VST3_BUNDLE"
          codesign --verify --deep --strict --verbose=2 "$APP_BUNDLE"
          spctl -a -vv "$APP_BUNDLE"

      - name: Stage macOS artifacts
        run: |
          mkdir -p artifacts/macos
          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "VST3 bundle not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          rsync -a "$VST3_BUNDLE" artifacts/macos/
          APP_BUNDLE=$(find build/juce/SeedboxApp_artefacts -path "*SeedBox Standalone.app" -maxdepth 5 -print -quit)
          if [[ -z "$APP_BUNDLE" ]]; then
            echo "SeedBox Standalone.app not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 5 -print
            exit 1
          fi
          rsync -a "$APP_BUNDLE" "artifacts/macos/SeedBox Standalone.app"

      - name: Stage macOS arm64 artifacts
        run: |
          mkdir -p artifacts/macos-arm64
          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "VST3 bundle not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          VST3_BINARY=$(find "$VST3_BUNDLE" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$VST3_BINARY" ]]; then
            echo "Could not locate a binary under $VST3_BUNDLE/Contents/MacOS" >&2
            find "$VST3_BUNDLE" -maxdepth 6 -print
            exit 1
          fi
          rsync -a "$VST3_BUNDLE" artifacts/macos-arm64/
          ARM64_VST3_BINARY=$(find "artifacts/macos-arm64/SeedBox.vst3" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$ARM64_VST3_BINARY" ]]; then
            echo "Could not locate arm64 VST3 binary target under artifacts/macos-arm64" >&2
            find "artifacts/macos-arm64/SeedBox.vst3" -maxdepth 6 -print
            exit 1
          fi
          lipo -thin arm64 "$VST3_BINARY" -output "$ARM64_VST3_BINARY"
          VST3_ARM64_INFO=$(lipo -info "$ARM64_VST3_BINARY")
          echo "$VST3_ARM64_INFO"
          if [[ "$VST3_ARM64_INFO" != *"Non-fat file:"*"arm64"* ]]; then
            echo "Expected arm64-only VST3 binary, got: $VST3_ARM64_INFO" >&2
            exit 1
          fi
          APP_BUNDLE=$(find build/juce/SeedboxApp_artefacts -path "*SeedBox Standalone.app" -maxdepth 5 -print -quit)
          if [[ -z "$APP_BUNDLE" ]]; then
            echo "SeedBox Standalone.app not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 5 -print
            exit 1
          fi
          APP_BINARY=$(find "$APP_BUNDLE" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$APP_BINARY" ]]; then
            echo "Could not locate a binary under $APP_BUNDLE/Contents/MacOS" >&2
            find "$APP_BUNDLE" -maxdepth 6 -print
            exit 1
          fi
          rsync -a "$APP_BUNDLE" "artifacts/macos-arm64/SeedBox Standalone.app"
          ARM64_APP_BINARY=$(find "artifacts/macos-arm64/SeedBox Standalone.app" -path "*/Contents/MacOS/*" -type f -print -quit)
          if [[ -z "$ARM64_APP_BINARY" ]]; then
            echo "Could not locate arm64 app binary target under artifacts/macos-arm64/SeedBox Standalone.app" >&2
            find "artifacts/macos-arm64/SeedBox Standalone.app" -maxdepth 6 -print
            exit 1
          fi
          lipo -thin arm64 "$APP_BINARY" -output "$ARM64_APP_BINARY"
          APP_ARM64_INFO=$(lipo -info "$ARM64_APP_BINARY")
          echo "$APP_ARM64_INFO"
          if [[ "$APP_ARM64_INFO" != *"Non-fat file:"*"arm64"* ]]; then
            echo "Expected arm64-only app binary, got: $APP_ARM64_INFO" >&2
            exit 1
          fi

      - name: Archive macOS artifacts
        run: tar -czf artifacts/seedbox-macos-universal.tar.gz -C artifacts macos

      - name: Archive macOS arm64 artifacts
        run: tar -czf artifacts/seedbox-macos-arm64.tar.gz -C artifacts macos-arm64

      - name: Note missing signing key (macOS)
        if: ${{ env.GPG_PRIVATE_KEY == '' }}
        run: 'echo "::notice::Skipping macOS signing: GPG_PRIVATE_KEY is not configured for this run."'

      - name: Import signing key
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ env.GPG_PRIVATE_KEY }}
        run: echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign macOS artifacts
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --local-user 4473F115745A1A61 \
              --detach-sign artifacts/seedbox-macos-universal.tar.gz

      - name: Generate ARM64 archive hash
        run: shasum -a 256 artifacts/seedbox-macos-arm64.tar.gz > artifacts/seedbox-macos-arm64.tar.gz.sha256

      - name: Sign macOS ARM64 archive
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --local-user 4473F115745A1A61 \
              --detach-sign artifacts/seedbox-macos-arm64.tar.gz

      - name: Upload macOS universal bundle
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-macos-universal
          path: |
            artifacts/macos
            artifacts/seedbox-macos-universal.tar.gz
          if-no-files-found: error

      - name: Upload macOS arm64 bundle
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-macos-arm64
          path: |
            artifacts/macos-arm64
            artifacts/seedbox-macos-arm64.tar.gz
          if-no-files-found: error

      - name: Upload macOS signature
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-macos-universal
          path: artifacts/seedbox-macos-universal.tar.gz.sig
          if-no-files-found: error

      - name: Upload macOS ARM64 hash
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-macos-arm64
          path: artifacts/seedbox-macos-arm64.tar.gz.sha256
          if-no-files-found: error

      - name: Upload macOS ARM64 signature
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-macos-arm64
          path: artifacts/seedbox-macos-arm64.tar.gz.sig
          if-no-files-found: error

  linux-host:
    name: Linux dependency + JUCE sanity
    needs: build
    runs-on: ubuntu-latest
    env:
      PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install JUCE dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            ninja-build \
            cmake \
            pkg-config \
            libx11-dev \
            libxinerama-dev \
            libxext-dev \
            libxrandr-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxcursor-dev \
            libgtk-3-dev \
            libfreetype6-dev \
            libwebkit2gtk-4.1-dev \
            libcurl4-openssl-dev \
            libasound2-dev \
            gnupg

      - name: Sanity check GTK/WebKit pkg-config wiring
        run: |
          pkg-config --cflags --libs gtk+-3.0
          pkg-config --cflags --libs webkit2gtk-4.1

      - name: Configure JUCE host build
        run: |
          GTK_WEBKIT_CFLAGS=$(pkg-config --cflags gtk+-3.0 webkit2gtk-4.1)
          GTK_WEBKIT_LIBS=$(pkg-config --libs gtk+-3.0 webkit2gtk-4.1)
          CURL_LIBS=$(pkg-config --libs libcurl)
          cmake -S . -B build/juce \
            -G Ninja \
            -DSEEDBOX_SIM=ON \
            -DQUIET_MODE=ON \
            -DSEEDBOX_VERSION="${{ github.sha }}" \
            -DJUCE_VST3_CAN_REPLACE_VST2=OFF \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_CXX_FLAGS_INIT="${GTK_WEBKIT_CFLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS_INIT="${GTK_WEBKIT_LIBS} ${CURL_LIBS}" \
            -DCMAKE_SHARED_LINKER_FLAGS_INIT="${GTK_WEBKIT_LIBS} ${CURL_LIBS}"

      - name: Build Linux targets
        run: cmake --build build/juce --config ${BUILD_TYPE} --target SeedboxVST3 SeedboxVST3_VST3 SeedboxApp

      - name: Stage Linux artifacts
        run: |
          mkdir -p artifacts/linux
          VST3_BUNDLE=$(find build/juce/SeedboxVST3_artefacts -name SeedBox.vst3 -print -quit)
          if [[ -z "$VST3_BUNDLE" ]]; then
            echo "SeedBox.vst3 not found under build/juce/SeedboxVST3_artefacts" >&2
            find build/juce/SeedboxVST3_artefacts -maxdepth 6 -print
            exit 1
          fi
          rsync -a "$VST3_BUNDLE" artifacts/linux/
          APP_BINARY=$(find build/juce/SeedboxApp_artefacts -maxdepth 6 -type f \( -name "SeedBox Standalone" -o -name "SeedBox" \) -print -quit)
          if [[ -z "$APP_BINARY" ]]; then
            echo "SeedBox standalone binary not found under build/juce/SeedboxApp_artefacts" >&2
            find build/juce/SeedboxApp_artefacts -maxdepth 6 -print
            exit 1
          fi
          install -m 755 "$APP_BINARY" "artifacts/linux/$(basename "$APP_BINARY")"

      - name: Archive Linux artifacts
        run: tar -czf artifacts/seedbox-linux-host.tar.gz -C artifacts linux

      - name: Note missing signing key (Linux)
        if: ${{ env.GPG_PRIVATE_KEY == '' }}
        run: 'echo "::notice::Skipping Linux signing: GPG_PRIVATE_KEY is not configured for this run."'

      - name: Import signing key
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PRIVATE_KEY: ${{ env.GPG_PRIVATE_KEY }}
        run: echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign Linux artifacts
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        env:
          GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes \
              --pinentry-mode loopback \
              --passphrase "${GPG_PASSPHRASE}" \
              --local-user 4473F115745A1A61 \
              --detach-sign artifacts/seedbox-linux-host.tar.gz

      - name: Upload Linux bundle
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-linux-host
          path: |
            artifacts/linux
            artifacts/seedbox-linux-host.tar.gz
          if-no-files-found: error

      - name: Upload Linux signature
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-linux-host
          path: artifacts/seedbox-linux-host.tar.gz.sig
          if-no-files-found: error

  windows-host:
    name: Windows dependency + JUCE sanity
    needs: build
    runs-on: windows-latest
    env:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up MSVC developer command prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja --no-progress

      - name: Ensure GnuPG available
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $gpg = Get-Command gpg -ErrorAction SilentlyContinue
          if ($gpg) {
            gpg --version
            return
          }

          choco install gnupg --yes --no-progress --execution-timeout=1200
          gpg --version

      - name: Configure JUCE host build
        shell: pwsh
        run: |
          cmake -S . -B build/juce `
            -G "Ninja" `
            -DSEEDBOX_SIM=ON `
            -DQUIET_MODE=ON `
            -DSEEDBOX_VERSION="${{ github.sha }}" `
            -DJUCE_VST3_CAN_REPLACE_VST2=OFF `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build Windows targets
        shell: pwsh
        run: cmake --build build/juce --config $env:BUILD_TYPE --target SeedboxVST3 SeedboxVST3_VST3 SeedboxApp

      - name: Stage Windows artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path artifacts/windows | Out-Null

          $vst3Bundle = Get-ChildItem -Path build/juce/SeedboxVST3_artefacts -Recurse -Directory -Filter "SeedBox.vst3" | Select-Object -First 1
          if (-not $vst3Bundle) {
            Write-Error "SeedBox.vst3 not found under build/juce/SeedboxVST3_artefacts"
          }
          Copy-Item -Path $vst3Bundle.FullName -Destination "artifacts/windows" -Recurse -Force

          $appBinary = Get-ChildItem -Path build/juce/SeedboxApp_artefacts -Recurse -File | Where-Object { $_.Name -in @("SeedBox Standalone.exe", "SeedBox.exe") } | Select-Object -First 1
          if (-not $appBinary) {
            Write-Error "SeedBox Standalone.exe or SeedBox.exe not found under build/juce/SeedboxApp_artefacts"
          }
          Copy-Item -Path $appBinary.FullName -Destination (Join-Path "artifacts/windows" $appBinary.Name) -Force

      - name: Archive Windows artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Compress-Archive -Path "artifacts/windows/*" -DestinationPath "artifacts/seedbox-windows-host.zip" -Force

      - name: Note missing signing key (Windows)
        if: ${{ env.GPG_PRIVATE_KEY == '' }}
        shell: pwsh
        run: 'echo "::notice::Skipping Windows signing: GPG_PRIVATE_KEY is not configured for this run."'

      - name: Import signing key
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        shell: pwsh
        env:
          GPG_PRIVATE_KEY: ${{ env.GPG_PRIVATE_KEY }}
        run: $env:GPG_PRIVATE_KEY | gpg --batch --import

      - name: Sign Windows artifacts
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        shell: pwsh
        env:
          GPG_PASSPHRASE: ${{ env.GPG_PASSPHRASE }}
        run: |
          gpg --batch --yes `
              --pinentry-mode loopback `
              --passphrase "$env:GPG_PASSPHRASE" `
              --local-user 4473F115745A1A61 `
              --detach-sign "artifacts/seedbox-windows-host.zip"

      - name: Upload Windows bundle
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-windows-host
          path: |
            artifacts/windows
            artifacts/seedbox-windows-host.zip
          if-no-files-found: error

      - name: Upload Windows signature
        if: ${{ env.GPG_PRIVATE_KEY != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: seedbox-windows-host
          path: artifacts/seedbox-windows-host.zip.sig
          if-no-files-found: error

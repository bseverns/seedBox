name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ENABLE_GOLDEN: "0"
    strategy:
      matrix:
        include:
          - name: native
            env: native
            usb: ''
            command: pio test -e native
          - name: teensy40
            env: teensy40
            usb: USB_MIDI_SERIAL
            command: pio run -e teensy40
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Surface build flag defaults
        run: |
          echo "SeedBoxConfig.h keeps the canonical build flags:"
          python scripts/describe_seedbox_config.py --format=markdown

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PlatformIO
        run: pip install --upgrade platformio

      - name: Confirm Teensy USB type
        if: ${{ matrix.usb != '' }}
        run: |
          python - <<'PY'
          from configparser import ConfigParser
          from pathlib import Path
          import sys

          env = "${{ matrix.env }}"
          expected = "${{ matrix.usb }}"

          config = ConfigParser(allow_no_value=True, strict=False)
          config.optionxform = str

          ini_path = Path("platformio.ini")
          if not ini_path.exists():
              print("platformio.ini not found", file=sys.stderr)
              sys.exit(1)

          with ini_path.open() as ini_file:
              config.read_file(ini_file)

          section = f"env:{env}"
          if section not in config:
              print(f"Environment section {section} missing", file=sys.stderr)
              sys.exit(1)

          usb_value = config[section].get("board_build.usbtype")
          if usb_value is None:
              print(f"No USB type configured for {env}", file=sys.stderr)
              sys.exit(1)

          usb_value = usb_value.strip()
          if usb_value != expected:
              print(
                  f"USB type mismatch for {env}: expected {expected}, found {usb_value}",
                  file=sys.stderr,
              )
              sys.exit(1)

          print(f"USB type for {env}: {usb_value}")
          PY

      - name: Execute ${{ matrix.name }} target
        run: ${{ matrix.command }}

      - name: Run native golden harness
        if: ${{ matrix.name == 'native' }}
        env:
          PLATFORMIO_BUILD_FLAGS: -D ENABLE_GOLDEN=1
          ENABLE_GOLDEN: "1"
          SEEDBOX_FIXTURE_ROOT: ${{ github.workspace }}/build/fixtures
        run: pio test -e native_golden

      - name: Refresh golden manifest
        if: ${{ matrix.name == 'native' }}
        run: |
          if [ ! -d build/fixtures ]; then
            echo "::error::Golden fixtures missing at build/fixtures. Did native_golden run?" >&2
            if [ -d build ]; then
              ls build
            fi
            exit 1
          fi
          python scripts/compute_golden_hashes.py --write

      - name: Stage golden fixtures for upload
        if: ${{ matrix.name == 'native' }}
        run: |
          mkdir -p artifacts/native_golden
          if [ ! -d build/fixtures ]; then
            echo "::error::Golden fixtures missing at build/fixtures. Cannot stage artifacts." >&2
            exit 1
          fi
          rsync -a build/fixtures/ artifacts/native_golden/
          cp tests/native_golden/golden.json artifacts/native_golden/

      - name: Upload native golden artifacts
        if: ${{ matrix.name == 'native' }}
        uses: actions/upload-artifact@v4
        with:
          name: native-golden-fixtures
          path: artifacts/native_golden
          if-no-files-found: error
